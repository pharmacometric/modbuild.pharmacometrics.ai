document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("compartment-select"),t=document.getElementById("admin-select"),l=document.getElementById("draw-button"),a=document.getElementById("main-canvas"),s=document.getElementById("plot-canvas"),i=document.getElementById("plot-scale-select"),n=document.getElementById("diagram-settings-panel"),o=document.getElementById("plot-settings-panel"),d=document.getElementById("canvas-width-input"),r=document.getElementById("canvas-height-input"),m=document.getElementById("image-scale-input"),c=document.getElementById("output-dimensions-preview"),p=document.getElementById("download-diagram-button"),u=document.getElementById("download-plot-button"),b=document.getElementById("download-code-button"),v=document.getElementById("download-nonmem-button"),$=document.getElementById("download-monolix-button"),g=document.getElementById("download-r-button"),x=new PharmaGraph("main-canvas","plot-canvas"),f={ka:"kₐ",ktr:"Ktr",mtt:"MTT = (N+1)/Ktr",k10:"k₁₀",k12:"k₁₂",k21:"k₂₁",k13:"k₁₃",k31:"k₃₁",iv:"IV Injection"},y=()=>{let e=document.querySelectorAll(".tab-button"),t=document.querySelectorAll(".tab-panel"),l=document.querySelector('[data-tab="diagram-settings"]');e.forEach(l=>{l.addEventListener("click",()=>{e.forEach(e=>{e.classList.remove("border-blue-500","text-blue-600"),e.classList.add("border-transparent","text-gray-500")}),l.classList.add("border-blue-500","text-blue-600"),l.classList.remove("border-transparent","text-gray-500"),t.forEach(e=>e.classList.add("hidden")),document.getElementById(`${l.dataset.tab}-panel`).classList.remove("hidden")})}),l&&l.click()},h=()=>{o.innerHTML=`<div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div class="space-y-3 col-span-2 border-b pb-4 mb-2">
                         <h4 class="font-semibold">Dosing Regimen</h4>
                         <div class="grid grid-cols-3 gap-2">
                            <label class="block text-sm">Amount:<input type="number" id="sim-dose" value="100" min="0" class="mt-1 w-full text-sm rounded-md border-slate-300"></label>
                            <label class="block text-sm">Doses:<input type="number" id="sim-num-doses" value="1" min="1" class="mt-1 w-full text-sm rounded-md border-slate-300"></label>
                            <label class="block text-sm">Interval (h):<input type="number" id="sim-interval" value="24" min="0" class="mt-1 w-full text-sm rounded-md border-slate-300"></label>
                         </div>
                    </div>
                    <div class="space-y-3"><h4 class="font-semibold mb-2">X-Axis</h4><label class="block text-sm">Title: <input type="text" id="plot-xtitle" value="Time" class="mt-1 w-full text-sm rounded-md border-slate-300"></label><label class="block text-sm">Min: <input type="number" id="plot-xmin" value="0" class="mt-1 w-full text-sm rounded-md border-slate-300"></label><label class="block text-sm">Max: <input type="number" id="plot-xmax" value="48" class="mt-1 w-full text-sm rounded-md border-slate-300"></label><label class="block text-sm">Step: <input type="number" id="plot-xstep" value="10" min="0" class="mt-1 w-full text-sm rounded-md border-slate-300"></label></div>
                    <div class="space-y-3"><h4 class="font-semibold mb-2">Y-Axis</h4><label class="block text-sm">Title: <input type="text" id="plot-ytitle" value="Concentration" class="mt-1 w-full text-sm rounded-md border-slate-300"></label><label class="block text-sm">Min: <input type="number" id="plot-ymin" value="0" class="mt-1 w-full text-sm rounded-md border-slate-300"></label><label class="block text-sm">Max: <input type="number" id="plot-ymax" value="5" class="mt-1 w-full text-sm rounded-md border-slate-300"></label><label class="block text-sm">Step: <input type="number" id="plot-ystep" value="1" min="0" class="mt-1 w-full text-sm rounded-md border-slate-300"></label></div>
                    <div class="space-y-3 col-span-2 border-t pt-4 mt-2">
                        <h4 class="font-semibold mb-2">Plot Appearance</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm">Font Family:<select id="plot-font-family" class="mt-1 w-full text-sm rounded-md border-slate-300"><option>sans-serif</option><option>serif</option><option>monospace</option></select></label></div>
                            <div><label class="block text-sm">Font Color:<input type="color" id="plot-font-color" value="#333333" class="mt-1 w-full h-9 p-0 rounded-md"></label></div>
                            <div><label class="block text-sm">Title Font Size:<input type="number" id="plot-title-fontsize" value="14" min="8" class="mt-1 w-full text-sm rounded-md border-slate-300"></label></div>
                            <div><label class="block text-sm">Tick Font Size:<input type="number" id="plot-tick-fontsize" value="12" min="6" class="mt-1 w-full text-sm rounded-md border-slate-300"></label></div>
                            <div><label class="block text-sm">Line Color:<input type="color" id="plot-linecolor" value="#007bff" class="mt-1 w-full h-9 p-0 rounded-md"></label></div>
                        </div>
                         <div class="grid grid-cols-2 gap-4 mt-4">
                             <label class="block text-sm">Width (px):<input type="number" id="plot-width" value="860" min="200" step="10" class="mt-1 w-full text-sm rounded-md border-slate-300"></label>
                             <label class="block text-sm">Height (px):<input type="number" id="plot-height" value="300" min="200" step="10" class="mt-1 w-full text-sm rounded-md border-slate-300"></label>
                         </div>
                    </div>
                </div>`,o.querySelectorAll("input, select").forEach(e=>e.addEventListener("input",I)),document.getElementById("plot-width").addEventListener("input",C),document.getElementById("plot-height").addEventListener("input",C)},_=()=>{n.innerHTML="";let l=document.createElement("div");l.innerHTML='<h3 class="text-lg font-semibold text-slate-700 border-b pb-2 flex items-center gap-2"><i class="fa-solid fa-palette text-indigo-500"></i><span>Global Style</span></h3><div class="grid grid-cols-[120px_1fr] items-center gap-3 mt-3"><label for="shape-select" class="text-sm font-semibold text-slate-600 text-right">Comp. Shape:</label><select id="shape-select" class="w-full text-sm rounded-md border-slate-300"><option value="rectangle" selected>Rectangle</option><option value="circle">Circle</option></select></div><div class="grid grid-cols-[120px_1fr] items-center gap-3 mt-3"><label for="font-family-select" class="text-sm font-semibold text-slate-600 text-right">Font Family:</label><select id="font-family-select" class="w-full text-sm rounded-md border-slate-300"><option>sans-serif</option><option>serif</option><option>monospace</option></select></div><div class="grid grid-cols-[120px_1fr] items-center gap-3 mt-3"><label for="font-size-input" class="text-sm font-semibold text-slate-600 text-right">Font Size:</label><input type="number" id="font-size-input" value="16" min="8" class="w-full text-sm rounded-md border-slate-300"></div><div class="grid grid-cols-[120px_1fr] items-center gap-3 mt-3"><label for="text-color-input" class="text-sm font-semibold text-slate-600 text-right">Text Color:</label><input type="color" id="text-color-input" value="#000000" class="w-full h-9 p-0 rounded-md"></div><div class="grid grid-cols-[120px_1fr] items-center gap-3 mt-3"><label for="line-color-input" class="text-sm font-semibold text-slate-600 text-right">Line/Arrow Color:</label><input type="color" id="line-color-input" value="#333333" class="w-full h-9 p-0 rounded-md"></div>',n.appendChild(l);let a=document.createElement("div");a.innerHTML='<h3 class="text-lg font-semibold text-slate-700 border-b pb-2 mt-4 flex items-center gap-2"><i class="fa-solid fa-right-left text-teal-500"></i><span>Rate Constants & Labels</span></h3>';let s=["k10"];parseInt(e.value,10)>=2&&s.push("k12","k21"),parseInt(e.value,10)>=3&&s.push("k13","k31"),"oral"===t.value&&s.push("ka"),"transit"===t.value&&s.push("ktr","mtt"),"iv"===t.value&&s.push("iv"),s.forEach(e=>{a.innerHTML+=`<div class="grid grid-cols-[120px_1fr] items-center gap-3 mt-3"><label for="label-${e}" class="text-sm font-semibold text-slate-600 text-right">${e.toUpperCase()}:</label><input type="text" id="label-${e}" value="${f[e]}" class="w-full text-sm rounded-md border-slate-300"></div>`}),"transit"===t.value&&(a.innerHTML+='<div class="grid grid-cols-[120px_1fr] items-center gap-3 mt-3"><label for="num-transit-input" class="text-sm font-semibold text-slate-600 text-right"># Transit Comps (N):</label><input type="number" id="num-transit-input" value="4" min="1" class="w-full text-sm rounded-md border-slate-300"></div>'),n.appendChild(a);let i={ka:{t:"Absorption",c:"#D3E4CD"},c1:{t:"Central C₁",c:"#FDFD96"},c2:{t:"Peripheral C₂",c:"#C8E6C9"},c3:{t:"Peripheral C₃",c:"#B2DFDB"}},o=document.createElement("div");o.innerHTML='<h3 class="text-lg font-semibold text-slate-700 border-b pb-2 mt-4 flex items-center gap-2"><i class="fa-solid fa-box text-orange-500"></i><span>Compartments</span></h3>';let d=["c1"];parseInt(e.value,10)>=2&&d.push("c2"),parseInt(e.value,10)>=3&&d.push("c3"),("oral"===t.value||"transit"===t.value)&&d.unshift("ka"),d.forEach(e=>{let t=i[e];o.innerHTML+=`<div class="flex flex-col gap-3 pt-4 border-t border-slate-200 mt-4"><div class="grid grid-cols-[120px_1fr] items-center gap-3"><label for="text-${e}" class="text-sm font-semibold text-slate-600 text-right">${t.t.split(" ")[0]} Text:</label><input type="text" id="text-${e}" value="${t.t}" class="w-full text-sm rounded-md border-slate-300"></div><div class="grid grid-cols-[120px_1fr] items-center gap-3"><label for="color-${e}" class="text-sm font-semibold text-slate-600 text-right">BG Color:</label><input type="color" id="color-${e}" value="${t.c}" class="w-full h-9 p-0 rounded-md"></div></div>`}),n.appendChild(o),n.querySelectorAll("input, select").forEach(e=>e.addEventListener("input",B))},E=()=>{let l=parseInt(e.value,10),a=t.value,s=[],i={},o=e=>document.getElementById(e)?.value||"",d=e=>parseInt(document.getElementById(e)?.value,10);n.querySelectorAll('input[id^="label-"]').forEach(e=>{i[e.id.replace("label-","")]=e.value}),n.querySelectorAll('input[id^="text-"]').forEach(e=>{let t=e.id.replace("text-","");s.push({id:t,text:e.value,color:o(`color-${t}`)})});let r={numComp:l,adminType:a,compartments:s,labels:i,options:{shape:o("shape-select"),fontFamily:o("font-family-select")||"sans-serif",fontSize:d("font-size-input")||16,textColor:o("text-color-input")||"#000000",lineColor:o("line-color-input")||"#333333"}};return"transit"===a&&(r.numTransit=d("num-transit-input")||4),r},k=()=>({scale:i.value,xTitle:document.getElementById("plot-xtitle").value,yTitle:document.getElementById("plot-ytitle").value,lineColor:document.getElementById("plot-linecolor").value,xMin:parseFloat(document.getElementById("plot-xmin").value),xMax:parseFloat(document.getElementById("plot-xmax").value),xStep:parseFloat(document.getElementById("plot-xstep").value),yMin:parseFloat(document.getElementById("plot-ymin").value),yMax:parseFloat(document.getElementById("plot-ymax").value),yStep:parseFloat(document.getElementById("plot-ystep").value),fontFamily:document.getElementById("plot-font-family").value,titleFontSize:parseInt(document.getElementById("plot-title-fontsize").value,10),tickFontSize:parseInt(document.getElementById("plot-tick-fontsize").value,10),fontColor:document.getElementById("plot-font-color").value}),w=()=>({dose:parseFloat(document.getElementById("sim-dose").value)||100,numDoses:parseInt(document.getElementById("sim-num-doses").value,10)||1,interval:parseFloat(document.getElementById("sim-interval").value)||24}),B=()=>{x.drawModel(E(),k(),w())},I=()=>{x.plotter.draw(x.simulator.solve(E(),w()),k())},L=()=>{a.width=parseInt(d.value,10)||900,a.height=parseInt(r.value,10)||450,T(),B()},C=()=>{s.width=parseInt(document.getElementById("plot-width").value,10)||860,s.height=parseInt(document.getElementById("plot-height").value,10)||300,I()},T=()=>{let e=parseInt(d.value,10)||0,t=parseInt(r.value,10)||0,l=parseFloat(m.value)||1;c.textContent=`(Output: ${Math.round(e*l)} x ${Math.round(t*l)} px)`},S=(e,t)=>{html2canvas(document.getElementById(e),{scale:parseFloat(m.value)||3,backgroundColor:"#FFFFFF"}).then(e=>{e.toBlob(e=>{saveAs(e,`${t}.${document.getElementById("image-format-select").value}`)},`image/${document.getElementById("image-format-select").value}`)})},F=()=>{let e=E(),t=k(),l=w(),i=JSON.stringify(e,null,4),n=JSON.stringify(t,null,4),o=JSON.stringify(l,null,4),d=`<!DOCTYPE html><html><head><title>Generated Diagram</title><style>body{display:flex;flex-direction:column;justify-content:center;align-items:center;padding:2rem;background-color:#f0f0f0}canvas{background-color:#fff;border:1px solid #ccc;margin-bottom:1rem;}</style></head><body><canvas id="model-canvas" width="${a.width}" height="${a.height}"></canvas><canvas id="plot-canvas" width="${s.width}" height="${s.height}"></canvas><script>${PharmaGraph.toString()};${PK_Simulator.toString()};${Plotter.toString()}</script><script>document.addEventListener('DOMContentLoaded',()=>{const g=new PharmaGraph('model-canvas','plot-canvas');const modelConfig=${i};const plotOptions=${n};const simOptions=${o};g.drawModel(modelConfig,plotOptions,simOptions)})</script></body></html>`;saveAs(new Blob([d.trim()],{type:"text/html;charset=utf-8"}),`visualizer-${e.numComp}-comp-${e.adminType}.html`)},M=e=>{let t=E(),l,a;"nonmem"===e?(l=generateNonmemCode(t),a="mod"):"monolix"===e?(l=generateMonolixCode(t),a="txt"):(l=generateRCode(t),a="R");let s=new Blob([l.trim()],{type:"text/plain;charset=utf-8"}),i=`${t.numComp}-comp-${t.adminType}.${a}`;saveAs(s,i)};[e,t].forEach(e=>e.addEventListener("change",()=>{_(),B()})),l.addEventListener("click",B),i.addEventListener("change",I),p.addEventListener("click",()=>S("main-canvas",`${e.value}-comp-${t.value}-diagram`)),u.addEventListener("click",()=>S("plot-canvas",`${e.value}-comp-${t.value}-plot`)),b.addEventListener("click",F),d.addEventListener("input",L),r.addEventListener("input",L),m.addEventListener("input",T),v.addEventListener("click",()=>M("nonmem")),$.addEventListener("click",()=>M("monolix")),g.addEventListener("click",()=>M("r")),y(),h(),_(),B(),T()});