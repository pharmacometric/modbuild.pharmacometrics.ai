class PK_Simulator{solve(t,i={}){let{numComp:e,adminType:s,numTransit:o=4}=t,{dose:h=100,numDoses:r=1,interval:a=24}=i,l={CL:10,V1:40,Q2:5,V2:60,Q3:2,V3:100,KA:1,MTT:2};l.N=o,l.MTT>0?l.KTR=(l.N+1)/l.MTT:l.KTR=0,l.K10=l.V1>0?l.CL/l.V1:0,e>1&&(l.K12=l.V1>0?l.Q2/l.V1:0,l.K21=l.V2>0?l.Q2/l.V2:0),e>2&&(l.K13=l.V1>0?l.Q3/l.V1:0,l.K31=l.V3>0?l.Q3/l.V3:0);let n=1+(e-1)+(s.includes("oral")||s.includes("transit")?1:0)+("transit"===s?o:0),c=Array(n).fill(0),d=e>1?1:-1,g=e>2?2:-1,u=-1,f=-1,x=0;"iv"!==s&&(x=u=1+(e-1),"transit"===s&&(f=u+1));let w=[],p=a*(r-1)+48,$=0,m=0;for(let _=0;_<=p;_+=.1){m<r&&_>=$&&(c[x]+=h,m++,$+=a),w.push({time:_,conc:l.V1>0?c[0]/l.V1:0});let Q=Array(c.length).fill(0),v=c[0],T=e>1?c[d]:0,b=e>2?c[g]:0;if(Q[0]=-l.K10*v,e>1&&(Q[0]+=-l.K12*v+l.K21*T,Q[d]=l.K12*v-l.K21*T),e>2&&(Q[0]+=-l.K13*v+l.K31*b,Q[g]=l.K13*v-l.K31*b),"oral"===s){let C=c[u];Q[u]=-l.KA*C,Q[0]+=l.KA*C}if("transit"===s){let A=c[u];Q[u]=-l.KTR*A;let k=l.KTR*A;for(let y=0;y<o;y++){let K=f+y,S=c[K];Q[K]=k-l.KTR*S,k=l.KTR*S}Q[0]+=k}for(let P=0;P<c.length;P++)c[P]+=.1*Q[P]}return w}}class Plotter{constructor(t){this.canvas=document.getElementById(t),this.canvas?this.ctx=this.canvas.getContext("2d"):(console.warn(`Plot canvas with ID "${t}" not found.`),this.ctx=null),this.padding={top:30,right:30,bottom:50,left:60}}clear(){this.ctx&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}draw(t,i={}){if(!this.ctx||(this.clear(),!t||0===t.length))return;let{scale:e="linear",xTitle:s="Time",yTitle:o="Concentration",lineColor:h="#007bff",xMin:r=0,xMax:a=Math.max(...t.map(t=>t.time)),xStep:l=a/5,yMin:n=0,yMax:c=1.1*Math.max(...t.map(t=>t.conc)),yStep:d=c/5,fontFamily:g="sans-serif",titleFontSize:u=14,tickFontSize:f=12,fontColor:x="#333333"}=i,w=this.canvas.width,p=this.canvas.height,$=this.padding,m=w-$.left-$.right,_=p-$.top-$.bottom,Q,v;if(this.ctx.fillStyle=x,this.ctx.textAlign="center",this.ctx.textBaseline="middle","log"===e){let T=Math.max(Math.min(...t.filter(t=>t.conc>0).map(t=>t.conc)),.001),b=Math.log10(n>0?n:T),C=Math.log10(c>n?c:10*n);Q=t=>t<=0?p:C<=b?p-$.bottom:p-$.bottom-(Math.log10(t)-b)/(C-b)*_,v=[];for(let A=Math.floor(b);A<=Math.ceil(C);A++)v.push(Math.pow(10,A))}else{let k=c>n?c-n:1;Q=t=>p-$.bottom-(t-n)/k*_,v=[];let y=d>0?d:1;for(let K=n;K<=c;K+=y)v.push(K)}let S=a>r?a-r:1,P=t=>$.left+(t-r)/S*m;this.ctx.beginPath(),this.ctx.moveTo($.left,$.top),this.ctx.lineTo($.left,p-$.bottom),this.ctx.lineTo(w-$.right,p-$.bottom),this.ctx.strokeStyle=x,this.ctx.stroke(),this.ctx.font=`bold ${u}px ${g}`,this.ctx.fillText(s,$.left+m/2,p-$.bottom/2+5),this.ctx.font=`${f}px ${g}`;let V=l>0?l:1;for(let D=r;D<=a;D+=V)this.ctx.fillText(D.toFixed(0),P(D),p-$.bottom+(f+5));this.ctx.save(),this.ctx.rotate(-Math.PI/2),this.ctx.font=`bold ${u}px ${g}`,this.ctx.fillText(o+("log"===e?" (log scale)":""),-p/2,$.left-(u+35)),this.ctx.restore(),this.ctx.textAlign="right",this.ctx.font=`${f}px ${g}`,v.forEach(t=>{this.ctx.fillText(t.toPrecision(2),$.left-8,Q(t))}),this.ctx.beginPath();let I=t.find(t=>t.time>=r);I&&(this.ctx.moveTo(P(I.time),Q(I.conc)),t.forEach(t=>{t.time>=r&&t.time<=a&&("log"!==e||!(t.conc<=0))&&this.ctx.lineTo(P(t.time),Q(t.conc))}),this.ctx.strokeStyle=h,this.ctx.lineWidth=2,this.ctx.stroke())}}class PharmaGraph{constructor(t,i){if(this.canvas=document.getElementById(t),!this.canvas)throw Error(`Diagram canvas with ID "${t}" not found.`);this.ctx=this.canvas.getContext("2d"),this.config={compWidth:100,compHeight:60,spacing:100,arrowHeadSize:10,lineWidth:2,fontFamily:"sans-serif",textColor:"#000000",arrowColor:"#333333",animationSpeed:100},this.drawingQueue=[],this.isAnimating=!1,this.simulator=new PK_Simulator,this.plotter=new Plotter(i)}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}updateConfig(t){this.config={...this.config,...t}}drawCompartment(t,i,e,s={}){let{color:o="#F0E68C",fontSize:h=16,shape:r="rectangle",width:a=this.config.compWidth,height:l=this.config.compHeight}=s,n=t+a/2,c=i+l/2;this.ctx.fillStyle=o,this.ctx.strokeStyle=this.config.arrowColor,this.ctx.lineWidth=this.config.lineWidth,"circle"===r?(this.ctx.beginPath(),this.ctx.arc(n,c,Math.max(a,l)/2,0,2*Math.PI,!1),this.ctx.fill(),this.ctx.stroke()):(this.ctx.fillRect(t,i,a,l),this.ctx.strokeRect(t,i,a,l)),this.ctx.fillStyle=this.config.textColor,this.ctx.font=`${h}px ${this.config.fontFamily}`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(e,n,c)}drawArrow(t,i,e,s,o="",h="above"){let r=this.config.arrowHeadSize,a=Math.atan2(s-i,e-t);if(this.ctx.strokeStyle=this.config.arrowColor,this.ctx.lineWidth=this.config.lineWidth,this.ctx.beginPath(),this.ctx.moveTo(t,i),this.ctx.lineTo(e,s),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(e,s),this.ctx.lineTo(e-r*Math.cos(a-Math.PI/6),s-r*Math.sin(a-Math.PI/6)),this.ctx.moveTo(e,s),this.ctx.lineTo(e-r*Math.cos(a+Math.PI/6),s-r*Math.sin(a+Math.PI/6)),this.ctx.stroke(),o){this.ctx.fillStyle=this.config.textColor,this.ctx.font=`italic 14px ${this.config.fontFamily}`,this.ctx.textAlign="center",this.ctx.textBaseline="middle";let l=0,n=0;switch(h){case"above":n=-15;break;case"below":n=15;break;case"left":l=-30,this.ctx.textAlign="right";break;case"right":l=30,this.ctx.textAlign="left"}this.ctx.fillText(o,(t+e)/2+l,(i+s)/2+n)}}_drawTransitChain(t,i,e){let{labels:s,options:o,numTransit:h=4}=t,r=.6*this.config.compWidth,a=.3*this.config.spacing,l=i,n=["Dose",...Array.from({length:h},(t,i)=>`${i+1}`)];return n.forEach((t,i)=>{let h=i===n.length-1,c=l;this.drawingQueue.push(()=>this.drawCompartment(c,e,t,{...o,width:r}));let d=l+r;this.drawingQueue.push(()=>this.drawArrow(d,e+this.config.compHeight/2,d+a,e+this.config.compHeight/2,h?s.ka||"Ka":s.ktr)),l=d+a}),this.drawingQueue.push(()=>{this.ctx.fillStyle=this.config.textColor,this.ctx.font=`14px ${this.config.fontFamily}`,this.ctx.textAlign="center",this.ctx.fillText(s.mtt,i+(l-i)/2,e+this.config.compHeight+30)}),l}_animateQueue(){if(0===this.drawingQueue.length){this.isAnimating=!1;let t=document.getElementById("draw-button");t&&(t.disabled=!1,t.classList.remove("opacity-50","cursor-not-allowed"),t.querySelector("span").textContent="Draw / Update Model");return}this.isAnimating=!0;let i=this.drawingQueue.shift();requestAnimationFrame(()=>{i(),setTimeout(()=>this._animateQueue(),this.config.animationSpeed)})}_drawTMDD(t){let{pkModel:i,compartments:e,options:s,labels:o,numTransit:h}=t,{numComp:r,adminType:a}=i,l=this.config.compWidth,n=this.config.compHeight,c=this.config.spacing,d=this.canvas.height/2,g,u=d-n/2,f=c/2;if("transit"===a)g=this._drawTransitChain({...t,numTransit:h},f,u);else{let x="",w="",p=e.find(t=>"ka"===t.id)||{};"iv"===a?(x=o.iv||"IV Dose",w=""):(x=p.text||"Absorption",w=o.ka),this.drawingQueue.push(()=>this.drawCompartment(f,u,x,{...s,color:p.color})),g=f+l+c,this.drawingQueue.push(()=>this.drawArrow(f+l,u+n/2,g,u+n/2,w,"above"))}if(this.drawingQueue.push(()=>this.drawCompartment(g,u,e.find(t=>"c1"===t.id).text,{...s,color:e.find(t=>"c1"===t.id).color})),this.drawingQueue.push(()=>this.drawArrow(g+l/2,u+n,g+l/2,u+n+c,o.kel,"right")),r>1){let $=u-n-c;this.drawingQueue.push(()=>this.drawCompartment(g,$,e.find(t=>"c2"===t.id).text,{...s,color:e.find(t=>"c2"===t.id).color})),this.drawingQueue.push(()=>this.drawArrow(g+l/2,u,g+l/2,$+n,o.k12,"right")),this.drawingQueue.push(()=>this.drawArrow(g+l/2,$+n,g+l/2,u,o.k21,"left"))}let m=g+l+c+c;this.drawingQueue.push(()=>{this.ctx.fillStyle=this.config.textColor,this.ctx.font=`bold 40px ${s.fontFamily}`,this.ctx.fillText("+",m-c/2,d)});let _=m,Q=d-n/2;this.drawingQueue.push(()=>this.drawCompartment(_,Q,e.find(t=>"rec"===t.id).text,{...s,shape:"rectangle",width:1.2*l,color:e.find(t=>"rec"===t.id).color})),this.drawingQueue.push(()=>this.drawArrow(_+.6*l,Q-c,_+.6*l,Q,o.ksyn,"right")),this.drawingQueue.push(()=>this.drawArrow(_+.6*l,Q+n,_+.6*l,Q+n+c,o.kdeg,"right"));let v=_+1.2*l+c;this.drawingQueue.push(()=>this.drawCompartment(v,Q,e.find(t=>"comp"===t.id).text,{...s,shape:"rectangle",width:1.2*l,color:e.find(t=>"comp"===t.id).color})),this.drawingQueue.push(()=>this.drawArrow(v+.6*l,Q+n,v+.6*l,Q+n+c,o.kint,"right")),this.drawingQueue.push(()=>this.drawArrow(_+1.2*l,Q+n/2,v,Q+n/2,o.kon,"above")),this.drawingQueue.push(()=>this.drawArrow(v,Q+n/2,_+1.2*l,Q+n/2,o.koff,"below"))}drawModel(t,i={},e={}){if(this.isAnimating)return;if("tmdd"===t.modelType)this.plotter.clear(),this.plotter.ctx.fillStyle="#666",this.plotter.ctx.font="16px sans-serif",this.plotter.ctx.textAlign="center",this.plotter.ctx.fillText("Simulation plot not available for TMDD models.",this.plotter.canvas.width/2,this.plotter.canvas.height/2);else{let s=this.simulator.solve(t,e);this.plotter.draw(s,i)}if(this.drawingQueue=[],this.clear(),this.updateConfig({textColor:t.options.textColor,arrowColor:t.options.lineColor,fontFamily:t.options.fontFamily}),"tmdd"===t.modelType)this._drawTMDD(t);else{let{numComp:o,adminType:h,compartments:r,options:a,labels:l}=t,n=this.config.compWidth,c=this.config.compHeight,d=this.config.spacing,g=this.canvas.height/2,u=this.canvas.width/2,f,x=g-c/2;if("iv"===h)f=1===o||3===o?u-n/2:u-n-d/2;else{let w=d;if("transit"===h)f=this._drawTransitChain(t,w,x);else{let p=r.find(t=>"ka"===t.id);p&&(this.drawingQueue.push(()=>this.drawCompartment(w,x,p.text,{...a,color:p.color})),this.drawingQueue.push(()=>this.drawArrow(w+n,x+c/2,w+n+d,x+c/2,l.ka,"above"))),f=w+n+d}}let $=r.find(t=>"c1"===t.id);if($&&this.drawingQueue.push(()=>this.drawCompartment(f,x,$.text,{...a,color:$.color})),"iv"===h&&this.drawingQueue.push(()=>this.drawArrow(f+n/2,x-d,f+n/2,x,l.iv,"right")),this.drawingQueue.push(()=>this.drawArrow(f+n/2,x+c,f+n/2,x+c+d,l.k10,"right")),o>=2){let m=r.find(t=>"c2"===t.id);if(m){let _=f+n+d;this.drawingQueue.push(()=>this.drawCompartment(_,x,m.text,{...a,color:m.color})),this.drawingQueue.push(()=>this.drawArrow(f+n,x+c/2,_,x+c/2,l.k12,"above")),this.drawingQueue.push(()=>this.drawArrow(_,x+c/2,f+n,x+c/2,l.k21,"below"))}}if(o>=3){let Q=r.find(t=>"c3"===t.id);if(Q){if("iv"===h){let v=f-n-d;this.drawingQueue.push(()=>this.drawCompartment(v,x,Q.text,{...a,color:Q.color})),this.drawingQueue.push(()=>this.drawArrow(f,x+c/2,v+n,x+c/2,l.k13,"above")),this.drawingQueue.push(()=>this.drawArrow(v+n,x+c/2,f,x+c/2,l.k31,"below"))}else{let T=x+c+d;this.drawingQueue.push(()=>this.drawCompartment(f,T,Q.text,{...a,color:Q.color})),this.drawingQueue.push(()=>this.drawArrow(f,x+c,f,T,l.k13,"left")),this.drawingQueue.push(()=>this.drawArrow(f,T,f,x+c,l.k31,"right"))}}}}let b=document.getElementById("draw-button");b&&(b.disabled=!0,b.classList.add("opacity-50","cursor-not-allowed"),b.querySelector("span").textContent="Drawing..."),this._animateQueue()}} 