class PK_Simulator{solve(t,i){let{numComp:e,adminType:s,numTransit:o=4}=t,{dose:h=100,numDoses:l=1,interval:r=24}=i,n={CL:10,V1:40,Q2:5,V2:60,Q3:2,V3:100,KA:1,MTT:2};n.N=o,n.MTT>0?n.KTR=(n.N+1)/n.MTT:n.KTR=0,n.K10=n.V1>0?n.CL/n.V1:0,e>1&&(n.K12=n.V1>0?n.Q2/n.V1:0,n.K21=n.V2>0?n.Q2/n.V2:0),e>2&&(n.K13=n.V1>0?n.Q3/n.V1:0,n.K31=n.V3>0?n.Q3/n.V3:0);let a=1;a+=e-1,(s.includes("oral")||s.includes("transit"))&&a++,"transit"===s&&(a+=o);let c=Array(a).fill(0),x=e>1?1:-1,d=e>2?2:-1,g=-1,f=-1,$=0;"iv"!==s&&($=g=1+(e-1),"transit"===s&&(f=g+1));let u=[],m=r*(l-1)+48,_=0,w=0;for(let p=0;p<=m;p+=.1){w<l&&p>=_&&(c[$]+=h,w++,_+=r);let v=n.V1>0?c[0]/n.V1:0;u.push({time:p,conc:v});let b=Array(c.length).fill(0),T=c[0],C=e>1?c[x]:0,Q=e>2?c[d]:0;if(b[0]=-n.K10*T,e>1&&(b[0]+=-n.K12*T+n.K21*C,b[x]=n.K12*T-n.K21*C),e>2&&(b[0]+=-n.K13*T+n.K31*Q,b[d]=n.K13*T-n.K31*Q),"oral"===s){let K=c[g];b[g]=-n.KA*K,b[0]+=n.KA*K}if("transit"===s){let A=c[g];b[g]=-n.KTR*A;let k=n.KTR*A;for(let y=0;y<o;y++){let P=f+y,S=c[P];b[P]=k-n.KTR*S,k=n.KTR*S}b[0]+=k}for(let V=0;V<c.length;V++)c[V]+=.1*b[V]}return u}}class Plotter{constructor(t){this.canvas=document.getElementById(t),this.canvas?this.ctx=this.canvas.getContext("2d"):(console.warn(`Plot canvas with ID "${t}" not found. Plotting will be disabled.`),this.ctx=null),this.padding={top:30,right:30,bottom:50,left:60}}clear(){this.ctx&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}draw(t,i={}){if(!this.ctx||(this.clear(),!t||0===t.length))return;let{scale:e="linear",xTitle:s="Time",yTitle:o="Concentration",lineColor:h="#007bff",xMin:l=0,xMax:r=Math.max(...t.map(t=>t.time)),xStep:n=r/5,yMin:a=0,yMax:c=1.1*Math.max(...t.map(t=>t.conc)),yStep:x=c/5,fontFamily:d="sans-serif",titleFontSize:g=14,tickFontSize:f=12,fontColor:$="#333333"}=i,u=this.canvas.width,m=this.canvas.height,_=this.padding,w=u-_.left-_.right,p=m-_.top-_.bottom,v,b;if(this.ctx.fillStyle=$,this.ctx.textAlign="center",this.ctx.textBaseline="middle","log"===e){let T=Math.max(Math.min(...t.filter(t=>t.conc>0).map(t=>t.conc)),.001),C=Math.log10(a>0?a:T),Q=Math.log10(c>a?c:10*a);v=t=>t<=0?m:Q<=C?m-_.bottom:m-_.bottom-(Math.log10(t)-C)/(Q-C)*p,b=[];for(let K=Math.floor(C);K<=Math.ceil(Q);K++)b.push(Math.pow(10,K))}else{let A=c>a?c-a:1;v=t=>m-_.bottom-(t-a)/A*p,b=[];let k=x>0?x:1;for(let y=a;y<=c;y+=k)b.push(y)}let P=r>l?r-l:1,S=t=>_.left+(t-l)/P*w;this.ctx.beginPath(),this.ctx.moveTo(_.left,_.top),this.ctx.lineTo(_.left,m-_.bottom),this.ctx.lineTo(u-_.right,m-_.bottom),this.ctx.strokeStyle=$,this.ctx.stroke(),this.ctx.font=`bold ${g}px ${d}`,this.ctx.fillText(s,_.left+w/2,m-_.bottom/2+5),this.ctx.font=`${f}px ${d}`;let V=n>0?n:1;for(let I=l;I<=r;I+=V)this.ctx.fillText(I.toFixed(0),S(I),m-_.bottom+(f+5));this.ctx.save(),this.ctx.rotate(-Math.PI/2),this.ctx.font=`bold ${g}px ${d}`,this.ctx.fillText(o+("log"===e?" (log scale)":""),-m/2,_.left-(g+35)),this.ctx.restore(),this.ctx.textAlign="right",this.ctx.font=`${f}px ${d}`,b.forEach(t=>{this.ctx.fillText(t.toPrecision(2),_.left-8,v(t))}),this.ctx.beginPath();let R=t.find(t=>t.time>=l);R&&(this.ctx.moveTo(S(R.time),v(R.conc)),t.forEach(t=>{t.time>=l&&t.time<=r&&("log"!==e||!(t.conc<=0))&&this.ctx.lineTo(S(t.time),v(t.conc))}),this.ctx.strokeStyle=h,this.ctx.lineWidth=2,this.ctx.stroke())}}class PharmaGraph{constructor(t,i){if(this.canvas=document.getElementById(t),!this.canvas)throw Error(`Diagram canvas with ID "${t}" not found.`);this.ctx=this.canvas.getContext("2d"),this.config={compWidth:100,compHeight:60,spacing:100,arrowHeadSize:10,lineWidth:2,fontFamily:"sans-serif",textColor:"#000000",arrowColor:"#333333",animationSpeed:100},this.drawingQueue=[],this.isAnimating=!1,this.simulator=new PK_Simulator,this.plotter=new Plotter(i)}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}updateConfig(t){this.config={...this.config,...t}}drawCompartment(t,i,e,s={}){let{color:o="#F0E68C",fontSize:h=16,shape:l="rectangle",width:r=this.config.compWidth,height:n=this.config.compHeight}=s,a=t+r/2,c=i+n/2;this.ctx.fillStyle=o,this.ctx.strokeStyle=this.config.arrowColor,this.ctx.lineWidth=this.config.lineWidth,"circle"===l?(this.ctx.beginPath(),this.ctx.arc(a,c,Math.max(r,n)/2,0,2*Math.PI,!1),this.ctx.fill(),this.ctx.stroke()):(this.ctx.fillRect(t,i,r,n),this.ctx.strokeRect(t,i,r,n)),this.ctx.fillStyle=this.config.textColor,this.ctx.font=`${h}px ${this.config.fontFamily}`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(e,a,c)}drawArrow(t,i,e,s,o="",h="above"){let l=this.config.arrowHeadSize,r=Math.atan2(s-i,e-t);if(this.ctx.strokeStyle=this.config.arrowColor,this.ctx.lineWidth=this.config.lineWidth,this.ctx.beginPath(),this.ctx.moveTo(t,i),this.ctx.lineTo(e,s),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(e,s),this.ctx.lineTo(e-l*Math.cos(r-Math.PI/6),s-l*Math.sin(r-Math.PI/6)),this.ctx.moveTo(e,s),this.ctx.lineTo(e-l*Math.cos(r+Math.PI/6),s-l*Math.sin(r+Math.PI/6)),this.ctx.stroke(),o){this.ctx.fillStyle=this.config.textColor,this.ctx.font=`italic 14px ${this.config.fontFamily}`,this.ctx.textAlign="center",this.ctx.textBaseline="middle";let n=0,a=0;switch(h){case"above":a=-15;break;case"below":a=15;break;case"left":n=-30,this.ctx.textAlign="right";break;case"right":n=30,this.ctx.textAlign="left"}this.ctx.fillText(o,(t+e)/2+n,(i+s)/2+a)}}_drawTransitChain(t,i,e){let{labels:s,options:o,numTransit:h=4}=t,l=.6*this.config.compWidth,r=.3*this.config.spacing,n=i,a=["Dose",...Array.from({length:h},(t,i)=>`${i+1}`)];return a.forEach((t,i)=>{let h=i===a.length-1,c=n;this.drawingQueue.push(()=>this.drawCompartment(c,e,t,{...o,width:l}));let x=n+l;this.drawingQueue.push(()=>this.drawArrow(x,e+this.config.compHeight/2,x+r,e+this.config.compHeight/2,h?s.ka||"Ka":s.ktr)),n=x+r}),this.drawingQueue.push(()=>{this.ctx.fillStyle=this.config.textColor,this.ctx.font=`14px ${this.config.fontFamily}`,this.ctx.textAlign="center",this.ctx.fillText(s.mtt,i+(n-i)/2,e+this.config.compHeight+30)}),n}_animateQueue(){if(0===this.drawingQueue.length){this.isAnimating=!1;let t=document.getElementById("draw-button");t&&(t.disabled=!1,t.classList.remove("opacity-50","cursor-not-allowed"),t.querySelector("span").textContent="Draw / Update Model");return}this.isAnimating=!0;let i=this.drawingQueue.shift();requestAnimationFrame(()=>{i(),setTimeout(()=>this._animateQueue(),this.config.animationSpeed)})}drawModel(t,i={},e={}){if(this.isAnimating)return;let s=this.simulator.solve(t,e);this.plotter.draw(s,i),this.drawingQueue=[],this.clear();let{numComp:o,adminType:h,compartments:l,options:r,labels:n}=t;if(!l||!r||!n){console.error("Model configuration is incomplete.",t);return}this.updateConfig({textColor:r.textColor,arrowColor:r.lineColor,fontFamily:r.fontFamily});let a=this.config.compWidth,c=this.config.compHeight,x=this.config.spacing,d=this.canvas.height/2,g=this.canvas.width/2,f,$=d-c/2;if("iv"===h)f=1===o||3===o?g-a/2:g-a-x/2;else{let u=x;if("transit"===h)f=this._drawTransitChain(t,u,$);else{let m=l.find(t=>"ka"===t.id);m&&(this.drawingQueue.push(()=>this.drawCompartment(u,$,m.text,{...r,color:m.color})),this.drawingQueue.push(()=>this.drawArrow(u+a,$+c/2,u+a+x,$+c/2,n.ka,"above"))),f=u+a+x}}let _=l.find(t=>"c1"===t.id);if(!_){console.error("Central compartment (c1) not found in config.");return}if(this.drawingQueue.push(()=>this.drawCompartment(f,$,_.text,{...r,color:_.color})),"iv"===h&&this.drawingQueue.push(()=>this.drawArrow(f+a/2,$-x,f+a/2,$,n.iv,"right")),this.drawingQueue.push(()=>this.drawArrow(f+a/2,$+c,f+a/2,$+c+x,n.k10,"right")),o>=2){let w=l.find(t=>"c2"===t.id);if(w){let p=f+a+x;this.drawingQueue.push(()=>this.drawCompartment(p,$,w.text,{...r,color:w.color})),this.drawingQueue.push(()=>this.drawArrow(f+a,$+c/2,p,$+c/2,n.k12,"above")),this.drawingQueue.push(()=>this.drawArrow(p,$+c/2,f+a,$+c/2,n.k21,"below"))}}if(o>=3){let v=l.find(t=>"c3"===t.id);if(v){if("iv"===h){let b=f-a-x;this.drawingQueue.push(()=>this.drawCompartment(b,$,v.text,{...r,color:v.color})),this.drawingQueue.push(()=>this.drawArrow(f,$+c/2,b+a,$+c/2,n.k13,"above")),this.drawingQueue.push(()=>this.drawArrow(b+a,$+c/2,f,$+c/2,n.k31,"below"))}else{let T=$+c+x;this.drawingQueue.push(()=>this.drawCompartment(f,T,v.text,{...r,color:v.color})),this.drawingQueue.push(()=>this.drawArrow(f,$+c,f,T,n.k13,"left")),this.drawingQueue.push(()=>this.drawArrow(f,T,f,$+c,n.k31,"right"))}}}let C=document.getElementById("draw-button");C&&(C.disabled=!0,C.classList.add("opacity-50","cursor-not-allowed"),C.querySelector("span").textContent="Drawing..."),this._animateQueue()}}