class PK_Simulator{solve(t,i={}){let{numComp:e,adminType:s,numTransit:o=4}=t,{dose:h=100,numDoses:r=1,interval:l=24}=i,a={CL:10,V1:40,Q2:5,V2:60,Q3:2,V3:100,KA:1,MTT:2};a.N=o,a.MTT>0?a.KTR=(a.N+1)/a.MTT:a.KTR=0,a.K10=a.V1>0?a.CL/a.V1:0,e>1&&(a.K12=a.V1>0?a.Q2/a.V1:0,a.K21=a.V2>0?a.Q2/a.V2:0),e>2&&(a.K13=a.V1>0?a.Q3/a.V1:0,a.K31=a.V3>0?a.Q3/a.V3:0);let n=1;n+=e-1,(s.includes("oral")||s.includes("transit"))&&n++,"transit"===s&&(n+=o);let c=Array(n).fill(0),d=e>1?1:-1,g=e>2?2:-1,u=-1,f=-1,x=0;"iv"!==s&&(x=u=1+(e-1),"transit"===s&&(f=u+1));let w=[],p=l*(r-1)+48,$=0,m=0;for(let _=0;_<=p;_+=.1){m<r&&_>=$&&(c[x]+=h,m++,$+=l);let Q=a.V1>0?c[0]/a.V1:0;w.push({time:_,conc:Q});let v=Array(c.length).fill(0),T=c[0],b=e>1?c[d]:0,C=e>2?c[g]:0;if(v[0]=-a.K10*T,e>1&&(v[0]+=-a.K12*T+a.K21*b,v[d]=a.K12*T-a.K21*b),e>2&&(v[0]+=-a.K13*T+a.K31*C,v[g]=a.K13*T-a.K31*C),"oral"===s){let A=c[u];v[u]=-a.KA*A,v[0]+=a.KA*A}if("transit"===s){let k=c[u];v[u]=-a.KTR*k;let y=a.KTR*k;for(let K=0;K<o;K++){let S=f+K,P=c[S];v[S]=y-a.KTR*P,y=a.KTR*P}v[0]+=y}for(let V=0;V<c.length;V++)c[V]+=.1*v[V]}return w}}class Plotter{constructor(t){this.canvas=document.getElementById(t),this.canvas?this.ctx=this.canvas.getContext("2d"):(console.warn(`Plot canvas with ID "${t}" not found. Plotting will be disabled.`),this.ctx=null),this.padding={top:30,right:30,bottom:50,left:60}}clear(){this.ctx&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}draw(t,i={}){if(!this.ctx||(this.clear(),!t||0===t.length))return;let{scale:e="linear",xTitle:s="Time",yTitle:o="Concentration",lineColor:h="#007bff",xMin:r=0,xMax:l=Math.max(...t.map(t=>t.time)),xStep:a=l/5,yMin:n=0,yMax:c=1.1*Math.max(...t.map(t=>t.conc)),yStep:d=c/5,fontFamily:g="sans-serif",titleFontSize:u=14,tickFontSize:f=12,fontColor:x="#333333"}=i,w=this.canvas.width,p=this.canvas.height,$=this.padding,m=w-$.left-$.right,_=p-$.top-$.bottom,Q,v;if(this.ctx.fillStyle=x,this.ctx.textAlign="center",this.ctx.textBaseline="middle","log"===e){let T=Math.max(Math.min(...t.filter(t=>t.conc>0).map(t=>t.conc)),.001),b=Math.log10(n>0?n:T),C=Math.log10(c>n?c:10*n);Q=t=>t<=0?p:C<=b?p-$.bottom:p-$.bottom-(Math.log10(t)-b)/(C-b)*_,v=[];for(let A=Math.floor(b);A<=Math.ceil(C);A++)v.push(Math.pow(10,A))}else{let k=c>n?c-n:1;Q=t=>p-$.bottom-(t-n)/k*_,v=[];let y=d>0?d:1;for(let K=n;K<=c;K+=y)v.push(K)}let S=l>r?l-r:1,P=t=>$.left+(t-r)/S*m;this.ctx.beginPath(),this.ctx.moveTo($.left,$.top),this.ctx.lineTo($.left,p-$.bottom),this.ctx.lineTo(w-$.right,p-$.bottom),this.ctx.strokeStyle=x,this.ctx.stroke(),this.ctx.font=`bold ${u}px ${g}`,this.ctx.fillText(s,$.left+m/2,p-$.bottom/2+5),this.ctx.font=`${f}px ${g}`;let V=a>0?a:1;for(let D=r;D<=l;D+=V)this.ctx.fillText(D.toFixed(0),P(D),p-$.bottom+(f+5));this.ctx.save(),this.ctx.rotate(-Math.PI/2),this.ctx.font=`bold ${u}px ${g}`,this.ctx.fillText(o+("log"===e?" (log scale)":""),-p/2,$.left-(u+35)),this.ctx.restore(),this.ctx.textAlign="right",this.ctx.font=`${f}px ${g}`,v.forEach(t=>{this.ctx.fillText(t.toPrecision(2),$.left-8,Q(t))}),this.ctx.beginPath();let I=t.find(t=>t.time>=r);I&&(this.ctx.moveTo(P(I.time),Q(I.conc)),t.forEach(t=>{t.time>=r&&t.time<=l&&("log"!==e||!(t.conc<=0))&&this.ctx.lineTo(P(t.time),Q(t.conc))}),this.ctx.strokeStyle=h,this.ctx.lineWidth=2,this.ctx.stroke())}}class PharmaGraph{constructor(t,i){if(this.canvas=document.getElementById(t),!this.canvas)throw Error(`Diagram canvas with ID "${t}" not found.`);this.ctx=this.canvas.getContext("2d"),this.config={compWidth:100,compHeight:60,spacing:100,arrowHeadSize:10,lineWidth:2,fontFamily:"sans-serif",textColor:"#000000",arrowColor:"#333333",animationSpeed:100},this.drawingQueue=[],this.isAnimating=!1,this.simulator=new PK_Simulator,this.plotter=new Plotter(i)}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}updateConfig(t){this.config={...this.config,...t}}drawCompartment(t,i,e,s={}){let{color:o="#F0E68C",fontSize:h=16,shape:r="rectangle",width:l=this.config.compWidth,height:a=this.config.compHeight}=s,n=t+l/2,c=i+a/2;this.ctx.fillStyle=o,this.ctx.strokeStyle=this.config.arrowColor,this.ctx.lineWidth=this.config.lineWidth,"circle"===r?(this.ctx.beginPath(),this.ctx.arc(n,c,Math.max(l,a)/2,0,2*Math.PI,!1),this.ctx.fill(),this.ctx.stroke()):(this.ctx.fillRect(t,i,l,a),this.ctx.strokeRect(t,i,l,a)),this.ctx.fillStyle=this.config.textColor,this.ctx.font=`${h}px ${this.config.fontFamily}`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(e,n,c)}drawArrow(t,i,e,s,o="",h="above"){let r=this.config.arrowHeadSize,l=Math.atan2(s-i,e-t);if(this.ctx.strokeStyle=this.config.arrowColor,this.ctx.lineWidth=this.config.lineWidth,this.ctx.beginPath(),this.ctx.moveTo(t,i),this.ctx.lineTo(e,s),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(e,s),this.ctx.lineTo(e-r*Math.cos(l-Math.PI/6),s-r*Math.sin(l-Math.PI/6)),this.ctx.moveTo(e,s),this.ctx.lineTo(e-r*Math.cos(l+Math.PI/6),s-r*Math.sin(l+Math.PI/6)),this.ctx.stroke(),o){this.ctx.fillStyle=this.config.textColor,this.ctx.font=`italic 14px ${this.config.fontFamily}`,this.ctx.textAlign="center",this.ctx.textBaseline="middle";let a=0,n=0;switch(h){case"above":n=-15;break;case"below":n=15;break;case"left":a=-30,this.ctx.textAlign="right";break;case"right":a=30,this.ctx.textAlign="left"}this.ctx.fillText(o,(t+e)/2+a,(i+s)/2+n)}}_drawTransitChain(t,i,e){let{labels:s,options:o,numTransit:h=4}=t,r=.6*this.config.compWidth,l=.3*this.config.spacing,a=i,n=["Dose",...Array.from({length:h},(t,i)=>`${i+1}`)];return n.forEach((t,i)=>{let h=i===n.length-1,c=a;this.drawingQueue.push(()=>this.drawCompartment(c,e,t,{...o,width:r}));let d=a+r;this.drawingQueue.push(()=>this.drawArrow(d,e+this.config.compHeight/2,d+l,e+this.config.compHeight/2,h?s.ka||"Ka":s.ktr)),a=d+l}),this.drawingQueue.push(()=>{this.ctx.fillStyle=this.config.textColor,this.ctx.font=`14px ${this.config.fontFamily}`,this.ctx.textAlign="center",this.ctx.fillText(s.mtt,i+(a-i)/2,e+this.config.compHeight+30)}),a}_animateQueue(){if(0===this.drawingQueue.length){this.isAnimating=!1;let t=document.getElementById("draw-button");t&&(t.disabled=!1,t.classList.remove("opacity-50","cursor-not-allowed"),t.querySelector("span").textContent="Draw / Update Model");return}this.isAnimating=!0;let i=this.drawingQueue.shift();requestAnimationFrame(()=>{i(),setTimeout(()=>this._animateQueue(),this.config.animationSpeed)})}_drawTMDD(t){let{pkModel:i,compartments:e,options:s,labels:o}=t,{numComp:h,adminType:r}=i,l=this.config.compWidth,a=this.config.compHeight,n=this.config.spacing,c=this.canvas.height/2,d,g=c-a/2,u=n/2;if("transit"===r)d=this._drawTransitChain(t,u,g);else{let f="",x="",w=e.find(t=>"ka"===t.id)||{};"iv"===r?(f=o.iv||"IV Dose",x=""):(f=w.text||"Absorption",x=o.ka),this.drawingQueue.push(()=>this.drawCompartment(u,g,f,{...s,color:w.color})),d=u+l+n,this.drawingQueue.push(()=>this.drawArrow(u+l,g+a/2,d,g+a/2,x,"above"))}if(this.drawingQueue.push(()=>this.drawCompartment(d,g,e.find(t=>"c1"===t.id).text,{...s,color:e.find(t=>"c1"===t.id).color})),this.drawingQueue.push(()=>this.drawArrow(d+l/2,g+a,d+l/2,g+a+n,o.kel,"right")),h>1){let p=g-a-n;this.drawingQueue.push(()=>this.drawCompartment(d,p,e.find(t=>"c2"===t.id).text,{...s,color:e.find(t=>"c2"===t.id).color})),this.drawingQueue.push(()=>this.drawArrow(d+l/2,g,d+l/2,p+a,o.k12,"right")),this.drawingQueue.push(()=>this.drawArrow(d+l/2,p+a,d+l/2,g,o.k21,"left"))}let $=d+l+n+n;this.drawingQueue.push(()=>{this.ctx.fillStyle=this.config.textColor,this.ctx.font=`bold 40px ${s.fontFamily}`,this.ctx.fillText("+",$-n/2,c)});let m=$,_=c-a/2;this.drawingQueue.push(()=>this.drawCompartment(m,_,e.find(t=>"rec"===t.id).text,{...s,shape:"rectangle",width:1.2*l,color:e.find(t=>"rec"===t.id).color})),this.drawingQueue.push(()=>this.drawArrow(m+.6*l,_-n,m+.6*l,_,o.ksyn,"right")),this.drawingQueue.push(()=>this.drawArrow(m+.6*l,_+a,m+.6*l,_+a+n,o.kdeg,"right"));let Q=m+1.2*l+n;this.drawingQueue.push(()=>this.drawCompartment(Q,_,e.find(t=>"comp"===t.id).text,{...s,shape:"rectangle",width:1.2*l,color:e.find(t=>"comp"===t.id).color})),this.drawingQueue.push(()=>this.drawArrow(Q+.6*l,_+a,Q+.6*l,_+a+n,o.kint,"right")),this.drawingQueue.push(()=>this.drawArrow(m+1.2*l,_+a/2,Q,_+a/2,o.kon,"above")),this.drawingQueue.push(()=>this.drawArrow(Q,_+a/2,m+1.2*l,_+a/2,o.koff,"below"))}drawModel(t,i={},e={}){if(this.isAnimating)return;if("tmdd"===t.modelType)this.plotter.clear(),this.plotter.ctx.fillStyle="#666",this.plotter.ctx.font="16px sans-serif",this.plotter.ctx.textAlign="center",this.plotter.ctx.fillText("Simulation plot not available for TMDD models.",this.plotter.canvas.width/2,this.plotter.canvas.height/2);else{let s=this.simulator.solve(t,e);this.plotter.draw(s,i)}if(this.drawingQueue=[],this.clear(),this.updateConfig({textColor:t.options.textColor,arrowColor:t.options.lineColor,fontFamily:t.options.fontFamily}),"tmdd"===t.modelType)this._drawTMDD(t);else{let{numComp:o,adminType:h,compartments:r,options:l,labels:a}=t,n=this.config.compWidth,c=this.config.compHeight,d=this.config.spacing,g=this.canvas.height/2,u=this.canvas.width/2,f,x=g-c/2;if("iv"===h)f=1===o||3===o?u-n/2:u-n-d/2;else{let w=d;if("transit"===h)f=this._drawTransitChain(t,w,x);else{let p=r.find(t=>"ka"===t.id);p&&(this.drawingQueue.push(()=>this.drawCompartment(w,x,p.text,{...l,color:p.color})),this.drawingQueue.push(()=>this.drawArrow(w+n,x+c/2,w+n+d,x+c/2,a.ka,"above"))),f=w+n+d}}let $=r.find(t=>"c1"===t.id);if($&&this.drawingQueue.push(()=>this.drawCompartment(f,x,$.text,{...l,color:$.color})),"iv"===h&&this.drawingQueue.push(()=>this.drawArrow(f+n/2,x-d,f+n/2,x,a.iv,"right")),this.drawingQueue.push(()=>this.drawArrow(f+n/2,x+c,f+n/2,x+c+d,a.k10,"right")),o>=2){let m=r.find(t=>"c2"===t.id);if(m){let _=f+n+d;this.drawingQueue.push(()=>this.drawCompartment(_,x,m.text,{...l,color:m.color})),this.drawingQueue.push(()=>this.drawArrow(f+n,x+c/2,_,x+c/2,a.k12,"above")),this.drawingQueue.push(()=>this.drawArrow(_,x+c/2,f+n,x+c/2,a.k21,"below"))}}if(o>=3){let Q=r.find(t=>"c3"===t.id);if(Q){if("iv"===h){let v=f-n-d;this.drawingQueue.push(()=>this.drawCompartment(v,x,Q.text,{...l,color:Q.color})),this.drawingQueue.push(()=>this.drawArrow(f,x+c/2,v+n,x+c/2,a.k13,"above")),this.drawingQueue.push(()=>this.drawArrow(v+n,x+c/2,f,x+c/2,a.k31,"below"))}else{let T=x+c+d;this.drawingQueue.push(()=>this.drawCompartment(f,T,Q.text,{...l,color:Q.color})),this.drawingQueue.push(()=>this.drawArrow(f,x+c,f,T,a.k13,"left")),this.drawingQueue.push(()=>this.drawArrow(f,T,f,x+c,a.k31,"right"))}}}}let b=document.getElementById("draw-button");b&&(b.disabled=!0,b.classList.add("opacity-50","cursor-not-allowed"),b.querySelector("span").textContent="Drawing..."),this._animateQueue()}}